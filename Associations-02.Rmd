---
title: "AACN Survey - 2022"
subtitle: "Associations"
date: "`r format(Sys.time(), '%B, %Y')`"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r include=FALSE}
# Libraries ---------------------------------------------------------------

library(gtsummary)
library(haven)
library(labelled)
library(flextable)
library(glue)
library(tidyverse)

# Setup -------------------------------------------------------------------

source("00-variable_info.R", local = TRUE)
source("00-helper_functions.R", local = TRUE)

gtsummary::set_gtsummary_theme(theme_gtsummary)

flextable::set_flextable_defaults(
  table.layout = "autofit"
)

dta <- readRDS("data/raw_cleaned.rds")

labels <- labelled::var_label(dta)


missing_removed <- readxl::read_xlsx("AACN_survey-missing_values.xlsx", sheet = "MissingRemoved")

dta <- dta %>% filter(id %in% missing_removed$Responseid)

# in case Respect by variables are shown independenly
new_respect_labs <- labels[vars_respect_by] %>%  map(~ paste0("Respect by:", .))

new_comm_labs <- labels[vars_communication] %>%  map(~ paste0(., " rated Good or Excellent"))

```


## C6. Please rate the skill of your unit Nursing managers in the following areas

```{r include=FALSE}
pivot_question <- "C6. Please rate the skill of your unit Nursing managers in the following areas"
```

<br>


### with `C1. How would you rate the quality of communication in your unit among the following?`


<br>


```{r}
group_question <- "C1. How would you rate the quality of communication in your unit among the following?"

tbl_cross_correlation(dta, vars_skills_manager,vars_communication) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  flextable::add_header_row(
    values = c("", group_question), 
    colwidths = c(1,4)
  ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(5) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```


<br>


### with `C2. How would you rate the quality of collaboration in your unit among the following?`


<br>


```{r}
group_question <- "C2. How would you rate the quality of collaboration in your unit among the following?"

tbl_cross_correlation(dta, vars_skills_manager, vars_collaboration) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  flextable::add_header_row(
    values = c("", group_question), 
    colwidths = c(1,4)
  ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(5) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```


<br>


### with `C3. In your unit how would you rate the respect for nurses by each of the following?`


<br>


```{r}
group_question <- "C3. In your unit how would you rate the respect for nurses by each of the following?"

tbl_cross_correlation(dta, vars_skills_manager, vars_respect_by) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  flextable::add_header_row(
    values = c("", group_question), 
    colwidths = c(1,5)
  ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(6) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```


<br>


### with `To what extent, in your work as a nurse do you experience moral distress?`


<br>


```{r}
group_question <- "To what extent, in your work as a nurse do you experience moral distress?"

tbl_cross_correlation(dta, vars_skills_manager, moral_distress) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  # flextable::add_header_row(
  #   values = c("", group_question), 
  #   colwidths = c(1,1)
  # ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(2) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```

<br>


### with `With regard to staffing for your unit how often do you have the right number of registered nurses with the right knowledge and skills?`


<br>


```{r}
group_question <- "With regard to staffing for your unit how often do you have the right number of registered nurses with the right knowledge and skills?"

tbl_cross_correlation(dta, vars_skills_manager, staffing_right) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  # flextable::add_header_row(
  #   values = c("", group_question), 
  #   colwidths = c(1,1)
  # ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(2) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```



<br>


### with `C10. What are the main factors that keep you working in your current organization?`


<br>


```{r}
group_question <- "C10. What are the main factors that keep you working in your current organization?"

tbl_cross_correlation(dta, vars_skills_manager, c(fact_manager, fact_environment, fact_schedule)) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  flextable::add_header_row(
    values = c("", group_question), 
    colwidths = c(1,3)
  ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(4) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```




<br>


### with `C11. In the past year, in your work as a nurse, please indicate the number of times you personally experienced each of the following?`


```{r incidents, include=FALSE}

n_completed <- dta %>% filter(section == "Section C") %>% nrow()

n_abuse <- dta %>% filter(section == "Section C", incident_any == 1) %>% nrow()

pct_abuse <- scales::percent(n_abuse / n_completed, accuracy = 0.1)

```


<br>

#### Sexual harassment, Discrimination, Verbal abuse, Physical abuse incidents from A Nurse Manager VS Managers Skills


```{r eval=FALSE, include=FALSE}

dta %>% 
  filter(section == "Section C") %>% 
  mutate(incident_any = factor(incident_any, labels = c("No", "Yes"))) %>% 
  select(incident_any, vars_skills_manager) %>% 
  mutate(across(where(is.labelled), as_factor)) %>% 
  tbl_summary(
    by = incident_any
  ) %>% 
  modify_header(label = pivot_question) %>% 
  add_p( test = list(all_categorical() ~ "chisq.test") ) %>% 
  modify_caption( paste0("Association of '", pivot_question, "' and '", labels$incident_any, "'") )%>% 
  modify_spanning_header( all_stat_cols() ~ labels$incident_any ) 

```


```{r eval=FALSE, include=FALSE}


dta %>% 
  filter(incident_any == 1) %>% 
  mutate(across(all_of(vars_incident_all), ~if_else(. > 0, 1, 0))) %>% 
   tbl_cross_correlation(
         all_of(vars_skills_manager),
         matches("(abuse_phys|abuse_verb|discrim|harass)_(manager)")
         ) %>% 
  flextable()

```


<br>


Mean level of Manager's Skills rating Vs occurrence of any incident with Respect to Sexual harassment, Physical Abuse, Verbal Abuse, and Discrimination by the `Nurse Manager`.    

The rating of `r pivot_question` has been reversed coded as 1 = Poor, 2 = Fair, 3  Good, and 4 = Excellent, so higher mean score indicates better communication, collaboration etc..

The tables show the mean level [SD] of the rating of the Manager's Skills, across the groups of nurses who experienced at least one incident of harassment.


<br>


- `r labels$harass_manager`


<br>

```{r}


dta %>% 
  filter(incident_any == 1) %>% 
  mutate(across(all_of(vars_incident_all), ~if_else(. > 0, 1, 0))) %>% 
  mutate(across(all_of(vars_incident_all), ~factor(., labels = c("No", "Yes"))) ) %>% 
  mutate(across(all_of(vars_skills_manager), ~ 5 -.)) %>% 
  set_variable_labels(.labels = labels) %>% 
  select(harass_manager, vars_skills_manager) %>% 
  tbl_summary(by = harass_manager,
              type = everything() ~ "continuous"
              ) %>% 
  add_p() %>% 
  modify_header(label = pivot_question) %>% 
  modify_spanning_header( all_stat_cols() ~ paste0("Any Incident of ", labels$harass_manager )) 

```


<br>

- `r labels$abuse_phys_manager`


<br>

```{r}


dta %>% 
  filter(incident_any == 1) %>% 
  mutate(across(all_of(vars_incident_all), ~if_else(. > 0, 1, 0))) %>% 
  mutate(across(all_of(vars_incident_all), ~factor(., labels = c("No", "Yes"))) ) %>% 
  mutate(across(all_of(vars_skills_manager), ~ 5 -.)) %>% 
  set_variable_labels(.labels = labels) %>% 
  select(abuse_phys_manager, vars_skills_manager) %>% 
  tbl_summary(by = abuse_phys_manager,
              type = everything() ~ "continuous"
              ) %>% 
  add_p() %>% 
  modify_header(label = pivot_question) %>% 
  modify_spanning_header( all_stat_cols() ~ paste0("Any Incident of ", labels$abuse_phys_manager )) 

```



<br>

- `r labels$abuse_verb_manager`


<br>

```{r}


dta %>% 
  filter(incident_any == 1) %>% 
  mutate(across(all_of(vars_incident_all), ~if_else(. > 0, 1, 0))) %>% 
  mutate(across(all_of(vars_incident_all), ~factor(., labels = c("No", "Yes"))) ) %>% 
  mutate(across(all_of(vars_skills_manager), ~ 5 -.)) %>% 
  set_variable_labels(.labels = labels) %>% 
  select(abuse_verb_manager, vars_skills_manager) %>% 
  tbl_summary(by = abuse_verb_manager,
              type = everything() ~ "continuous"
              ) %>% 
  add_p() %>% 
  modify_header(label = pivot_question) %>% 
  modify_spanning_header( all_stat_cols() ~ paste0("Any Incident of ", labels$abuse_verb_manager )) 

```



<br>

- `r labels$discrim_manager`


<br>

```{r}


dta %>% 
  filter(incident_any == 1) %>% 
  mutate(across(all_of(vars_incident_all), ~if_else(. > 0, 1, 0))) %>% 
  mutate(across(all_of(vars_incident_all), ~factor(., labels = c("No", "Yes"))) ) %>% 
  mutate(across(all_of(vars_skills_manager), ~ 5 -.)) %>% 
  set_variable_labels(.labels = labels) %>% 
  select(discrim_manager, vars_skills_manager) %>% 
  tbl_summary(by = discrim_manager,
              type = everything() ~ "continuous"
              ) %>% 
  add_p() %>% 
  modify_header(label = pivot_question) %>% 
  modify_spanning_header( all_stat_cols() ~ paste0("Any Incident of ", labels$discrim_manager )) 

```



<br>


### with `C16. To what extent are you evaluated on how well you contribute to a healthy work environment for you and your colleagues?`


<br>


```{r}
group_question <- "C16. To what extent are you evaluated on how well you contribute to a healthy work environment for you and your colleagues?	"


dta %>% 
  filter(section == "Section C") %>%
  select(all_of(vars_skills_manager), evaluate_contrib_hwe) %>% 
  mutate(across(where(is.labelled), as_factor)) %>% 
  tbl_summary(
    by = evaluate_contrib_hwe
  ) %>% 
  add_p() %>% 
  modify_header(label = pivot_question) %>% 
  modify_spanning_header( all_stat_cols() ~ labels$evaluate_contrib_hwe ) %>% 
  modify_caption(paste0(
    "Association between '", pivot_question, "' and '", labels$evaluate_contrib_hwe, "'"))


```




<br>


### with `C17. On the whole, how satisfied are you with your current job?`


<br>


```{r}
group_question <- "C17. On the whole, how satisfied are you with your current job??	"

tbl_cross_correlation(dta, vars_skills_manager, satisfied_overall) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  # flextable::add_header_row(
  #   values = c("", group_question), 
  #   colwidths = c(1,3)
  # ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(2) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```



```{r}

dta %>% 
  filter(section == "Section C") %>%
  select(all_of(vars_skills_manager), plan_leave) %>% 
  mutate(across(where(is.labelled), as_factor)) %>% 
  tbl_summary(
    by = plan_leave
  ) %>% 
  add_p() %>% 
  modify_header(label = pivot_question) %>% 
  modify_spanning_header( all_stat_cols() ~ labels$plan_leave ) %>% 
  modify_caption(paste0(
    "Association between '", pivot_question, "' and '", labels$plan_leave, "'"))

```

<br>


### with `C18a. How likely would each of the following be to influence you to reconsider your plans to leave your present position?`


<br>


```{r}
group_question <- "C18a. How likely would each of the following be to influence you to reconsider your plans to leave your present position?"

tbl_cross_correlation(dta, vars_skills_manager, c(influence_5, influence_9, influence_11)) %>% 
  rename("C6. Skill of your unit Nursing managers:" = colsx) %>% 
  flextable() %>% 
  flextable::add_header_row(
    values = c("", group_question), 
    colwidths = c(1,3)
  ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(4) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", group_question, "` and `", pivot_question, "`"))

```


### With Demographics

```{r}

by_demo <- function(demo_var){
  
  demo_label <- labels[[deparse(substitute(demo_var))]]
  
  dta %>% 
  mutate(across(where(is.labelled), as_factor) ) %>% 
  tbl_summary(
    by = {{demo_var}},
    include = all_of(vars_skills_manager)
  ) %>% 
  add_p( test = list(all_categorical() ~ "chisq.test") ) %>% 
  modify_header(label = pivot_question) %>% 
  modify_spanning_header( all_stat_cols() ~ demo_label ) %>% 
  modify_caption(paste0(
    "Association between '", pivot_question, "' and '", demo_label, "'"))
}



```

<br>

- Gender

```{r}
by_demo(gender)
```


<br>

- Education

```{r}
by_demo(education)
```



<br>

- University Education

```{r}
by_demo(uni_education)
```

<br>

- Current position 

<br>

```{r}
by_demo(position)

```

<br>

- Place of current work 

<br>

```{r}
by_demo(workplace)

```

<br>

- Type of ICU 

<br>

```{r}
by_demo(icu_type)

```
<br>

- Country 

<br>

```{r}
by_demo(country)

```

<br>

- Years of total nursing experience

<br>

```{r}
dta %>% 
  filter(section == "Section C") %>%
  tbl_cross_correlation(all_of(vars_skills_manager), experience) %>% 
  rename(!!pivot_question := colsx) %>% 
  flextable() %>% 
  # flextable::add_header_row(
  #   values = c("", labels$experience), 
  #   colwidths = c(1,1)
  # ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(2) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", labels$experience, "` and `", pivot_question, "`"))

```

<br>

- Years of Experience in ICU critical/intensive care unit

<br>

```{r}
dta %>% 
  filter(section == "Section C") %>%
  tbl_cross_correlation(all_of(vars_skills_manager), experience_icu) %>% 
  rename(!!pivot_question := colsx) %>% 
  flextable() %>% 
  # flextable::add_header_row(
  #   values = c("", labels$experience_icu), 
  #   colwidths = c(1,1)
  # ) %>% 
  add_footer_row(
    values = c("Note: Spearman correlation coefficient (r). 
               * p < 0.05, ** p < 0.01 "), 
    colwidths = c(2) 
  ) %>% 
  set_caption(paste0(
    "Correlation between  `", labels$experience_icu, "` and `", pivot_question, "`"))

```






